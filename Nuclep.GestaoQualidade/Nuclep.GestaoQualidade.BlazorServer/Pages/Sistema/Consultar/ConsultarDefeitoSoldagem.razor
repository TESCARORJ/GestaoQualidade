@page "/Sistema/Consultar/ConsultarDefeitoSoldagem"
@using Microsoft.Extensions.Localization
@using Nuclep.GestaoQualidade.BlazorServer.DTOs
@using Nuclep.GestaoQualidade.BlazorServer.Helpers
@using Nuclep.GestaoQualidade.BlazorServer.Models
@using System.Security.Principal
@using Nuclep.GestaoQualidade.BlazorServer.Models.Consultar
@using Nuclep.GestaoQualidade.Domain.Enumeradores
@using System.Reflection
@using System.ComponentModel

@inject HttpClient Http
@inject NavigationManager Navigation
@inject NotificationService NotificationService


<RadzenCard Variant="Variant.Outlined" class="rz-my-4">
    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <div>
            <h3>Consulta de Defeito de Soldagem</h3>
            <h6 style="">Esse Indicador possui somente uma  por Ano</h6>
        </div>
        @if (IsExibeBotao)
        {
            <RadzenButton Text="Gerar Perguntas" Style="width: 20%" Click="@(args => CadastrarDefeitoSoldagem())" />
        }
    </RadzenStack>
</RadzenCard>

<RadzenDataGrid @ref="grid" AllowColumnResize="true" TItem="DefeitoSoldagemResponseDTO" PageSize="12" AllowPaging="true"
                Data="@model.DefeitoSoldagemList" ColumnWidth="300px"
                EmptyText="Nenhum registro encontrado"
                RowUpdate="@OnUpdateRow"
                EditMode="@editMode">
    <Columns>
        <!-- Hidden Column for UsuarioCadastro -->
        <RadzenDataGridColumn Property="UsuarioCadastro" Visible="false" />
        <RadzenDataGridColumn Property="UsuarioCadastroId" Visible="false" />
        <RadzenDataGridColumn Property="DataHoraCadastro" Visible="false" />
        <RadzenDataGridColumn Property="LocalidadeId" Visible="false" />
        <!---->


        <RadzenDataGridColumn Property="Meta" Title="Meta" Width="10%" />
        <RadzenDataGridColumn Property="Mes" Title="Mês" Width="10%" />
        <RadzenDataGridColumn Property="Ano" Title="Ano" Width="10%">
            <Template Context="data">
                @GetDescription(((EnumAno)data.Ano))
            </Template>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Property="LocalidadeNome" Title="Localidade" Width="10%" />


        <RadzenDataGridColumn Property="TotalDefeitosSoldaEncontradosEnsaiadosVolumetricos" Title="Total Defeitos de Solda Encontrados Ensaiados Volumétricos">
            <EditTemplate Context="data">
                <RadzenNumeric TValue="long?" @bind-Value="data.TotalDefeitosSoldaEncontradosEnsaiadosVolumetricos" Style="width: 100%;" />
            </EditTemplate>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Property="TotalComprimentoSoldadoInspecionado" Title="Total de Comprimento de Soldado Inspecionado">
            <EditTemplate Context="data">
                <RadzenNumeric TValue="long?" @bind-Value="data.TotalComprimentoSoldadoInspecionado" Style="width: 100%;" />
            </EditTemplate>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn Context="data" Filterable="false" Sortable="false" TextAlign="TextAlign.Right" Frozen="true" FrozenPosition="FrozenColumnPosition.Right" Width="10%">
            <Template Context="data">
                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" Click="@(args => EditRow(data))" @onclick:stopPropagation="true">
                </RadzenButton>

            </Template>
            <EditTemplate Context="data">
                <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat" Size="ButtonSize.Medium" Click="@((args) => SaveRow(data))" aria-label="Save">
                </RadzenButton>
                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@((args) => CancelEdit(data))" aria-label="Cancel">
                </RadzenButton>

            </EditTemplate>
        </RadzenDataGridColumn>


    </Columns>
</RadzenDataGrid>

@code {

    DataGridEditMode editMode = DataGridEditMode.Single;



    ConsultarDefeitoSoldagemModel model = new();
    ConsultarUsuarioModel usuarioModel = new();
    RadzenDataGrid<DefeitoSoldagemResponseDTO> grid;
    List<DefeitoSoldagemResponseDTO> dataToUpdate = new List<DefeitoSoldagemResponseDTO>();


    async Task EditRow(DefeitoSoldagemResponseDTO model)
    {

        dataToUpdate.Add(model);
        await grid.EditRow(model);
    }

    void CancelEdit(DefeitoSoldagemResponseDTO model)
    {
        Reset(model);

        grid.CancelEditRow(model);


    }

    void Reset()
    {
        dataToUpdate.Clear();
    }

    void Reset(DefeitoSoldagemResponseDTO model)
    {
        dataToUpdate.Remove(model);
    }

    void OnUpdateRow(DefeitoSoldagemResponseDTO model)
    {
        Reset(model);

        var response = Http.PutAsJsonAsync($"/api/DefeitoSoldagem/id/{model.Id}", model);
    }

    bool IsExibeBotao = false;


    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        var responseList = await Http.GetAsync("api/DefeitoSoldagem/GetAllUsarioLogado");
        model.DefeitoSoldagemList = await responseList.Content.ReadFromJsonAsync<List<DefeitoSoldagemResponseDTO>>();


        // var login = string.IsNullOrEmpty(WindowsIdentity.GetCurrent().Name) ? string.Empty : Utils.RemoverPrefixo(WindowsIdentity.GetCurrent().Name, "NUCLEP\\");

        // var isHabilitado = await Http.GetAsync("api/DefeitoSoldagem/IndicadorHabilitado?login=" + login);

        var login = string.IsNullOrEmpty(WindowsIdentity.GetCurrent().Name) ? string.Empty : Utils.RemoverPrefixo(WindowsIdentity.GetCurrent().Name, "NUCLEP\\");

        var usuarioLogin = await Http.GetAsync("api/Usuario/Usuario?login=" + login);

        var usuarioResponse = await usuarioLogin.Content.ReadFromJsonAsync<UsuarioResponseDTO>();
        if (usuarioResponse != null)
        {
            usuarioModel = new ConsultarUsuarioModel
                {

                    Nome = usuarioResponse.Nome,
                    PerfilSistema = usuarioResponse.PerfilSistema,
                    IsConfirmacaoNaoInformado = usuarioResponse.IsConfirmacaoNaoInformado,
                    IsLocalidadeAramar = usuarioResponse.IsLocalidadeAramar,
                    IsLocalidadeItaguai = usuarioResponse.IsLocalidadeItaguai,
                    IsCondensador = usuarioResponse.IsCondensador,
                    IsVPR = usuarioResponse.IsVPR,
                    IsNivelServicoAtendimento = usuarioResponse.IsNivelServicoAtendimento,
                    IsAderenciaProgramacaoMensal = usuarioResponse.IsAderenciaProgramacaoMensal,
                    IsCumprimentoEtapasPACDentroPrazo = usuarioResponse.IsCumprimentoEtapasPACDentroPrazo,
                    IsSatisfacaoUsuario = usuarioResponse.IsSatisfacaoUsuario,
                    IsTempoMedioSolucao = usuarioResponse.IsTempoMedioSolucao,
                    IsItensCadastradosMais15Dias = usuarioResponse.IsItensCadastradosMais15Dias,
                    IsDuracaoProcessoLicitacao = usuarioResponse.IsDuracaoProcessoLicitacao,
                    IsEventosAtraso = usuarioResponse.IsEventosAtraso,
                    IsFaturamentoRealizado = usuarioResponse.IsFaturamentoRealizado,
                    IsTempoManutencaoCorretivaEquipamentoProgramado = usuarioResponse.IsTempoManutencaoCorretivaEquipamentoProgramado,
                    IsAcaoCorrecaoAvaliadaEficaz = usuarioResponse.IsAcaoCorrecaoAvaliadaEficaz,
                    IsCumprimentoVerbaDestinadaPATMME = usuarioResponse.IsCumprimentoVerbaDestinadaPATMME,
                    IsAcaoDentroPrazo = usuarioResponse.IsAcaoDentroPrazo,
                    IsAutoavaliacaoGerencialSGQ = usuarioResponse.IsAutoavaliacaoGerencialSGQ,
                    IsCapacitacaoAreaContratos = usuarioResponse.IsCapacitacaoAreaContratos,
                    IsOcupacaoMaoObra = usuarioResponse.IsOcupacaoMaoObra,
                    IsProdutividadeMaoObra = usuarioResponse.IsProdutividadeMaoObra,
                    IsGestaoProcessosPessoasPrevistoPAT = usuarioResponse.IsGestaoProcessosPessoasPrevistoPAT,
                    IsRespostaAreasPrazoOriginal = usuarioResponse.IsRespostaAreasPrazoOriginal,
                    IsRetrabalhoDocumentos = usuarioResponse.IsRetrabalhoDocumentos,
                    IsSatisfacaoClientesAreaResponsavel = usuarioResponse.IsSatisfacaoClientesAreaResponsavel,
                    IsReducaoRNC = usuarioResponse.IsReducaoRNC,
                    IsTaxaConformidadeDocumentosQualidade = usuarioResponse.IsTaxaConformidadeDocumentosQualidade,
                    IsTempoMedioInspecaoRecebimentoMateriais = usuarioResponse.IsTempoMedioInspecaoRecebimentoMateriais,
                    IsTempoReparoEquipamentosProgramadosObras = usuarioResponse.IsTempoReparoEquipamentosProgramadosObras,
                    IsRejeicaoMateriaisAntesTratamento = usuarioResponse.IsRejeicaoMateriaisAntesTratamento

                };
        }


        if ((model.DefeitoSoldagemList == null || !model.DefeitoSoldagemList.Where(x => x.LocalidadeId == 1).Any() && usuarioModel.IsLocalidadeItaguai) ||
            (model.DefeitoSoldagemList == null || !model.DefeitoSoldagemList.Where(x => x.LocalidadeId == 2).Any() && usuarioModel.IsLocalidadeAramar) ||
            (model.DefeitoSoldagemList == null || !model.DefeitoSoldagemList.Where(x => x.LocalidadeId == 3).Any() && usuarioModel.IsCondensador) ||
            (model.DefeitoSoldagemList == null || !model.DefeitoSoldagemList.Where(x => x.LocalidadeId == 4).Any() && usuarioModel.IsVPR))
        {

            IsExibeBotao = true;

        }
    }

    private async Task CadastrarDefeitoSoldagem()
    {
        try
        {
            var isMetaPerguntas = await Http.GetAsync("/api/DefeitoSoldagem/VerificaMetaPerguntas");

            if (isMetaPerguntas.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Fala com o administrador", Detail = "Indicador sem meta definida!", Duration = 4000 });
            }
            else
            {
                string login = string.IsNullOrEmpty(WindowsIdentity.GetCurrent().Name) ? string.Empty : Utils.RemoverPrefixo(WindowsIdentity.GetCurrent().Name, "NUCLEP\\");

                ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Info, Summary = "Atenção", Detail = "Gerando perguntas.", Duration = 8000 });

                var response = await Http.GetAsync("/api/DefeitoSoldagem/gararperguntas/");

                if (response.IsSuccessStatusCode)
                {
                    await Task.Delay(4000);
                    Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
                }
            }




        }
        catch (Exception ex)
        {
            ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = $"Erro: {ex.Message}", Detail = "Falha!", Duration = 4000 });
        }
    }

    private void Editar(long id)
    {
        Navigation.NavigateTo($"Sistema/Editar/EditarDefeitoSoldagem/{id}");
    }

    void ShowNotification(NotificationMessage message)
    {
        NotificationService.Notify(message);
    }

    private async Task SaveRow(DefeitoSoldagemResponseDTO model)
    {
        try
        {
            // Envia a linha atualizada para a API
            // var response = await Http.PostAsJsonAsync("api/aderencia/salvar", data);
            var response = await Http.PutAsJsonAsync($"/api/DefeitoSoldagem/{model.Id}", model);


            //var result = await response.Content.ReadFromJsonAsync<DefeitoSoldagemResponseDTO>(); // Supondo um modelo de resposta com Success e Message

            if (response.IsSuccessStatusCode)
            {
                ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Indicador", Detail = "Salvo com sucesso!!", Duration = 4000 });

                grid.CancelEditRow(model);

            }
            else
            {
                ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Falha ao salvar", Detail = "Falha ao salvar", Duration = 4000 });
            }
        }
        catch (Exception ex)
        {
            ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = $"Erro: {ex.Message}", Detail = "Falha!", Duration = 4000 });
        }
    }

    string GetDescription(Enum value)
    {
        FieldInfo? field = value.GetType().GetField(value.ToString());
        DescriptionAttribute? attribute = field.GetCustomAttribute<DescriptionAttribute>();
        return attribute == null ? value.ToString() : attribute.Description;
    }

}



